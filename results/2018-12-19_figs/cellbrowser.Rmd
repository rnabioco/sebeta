---
title: "cellbrowser"
author: "Kent Riemondy RBI"
date: "2/27/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Cellbrowser

Format seurat object into a cellbrowser directory suitable for html browser. 

```{r}
source("../../R/globals.R")
library(tidyverse)
expts <- c("Sorted", "Reaggregated")

bcells <- map(expts, 
     ~readRDS(paste0(., "_final.rds")))

names(bcells) <- expts

```

Simplify object metadata to make interpretable

```{r}

cols <- map(bcells, ~colnames(.x@meta.data))

cols_to_keep <- c(
  `genes per cell` = "nGene",
  `UMIs per cell` = "nUMI",
  `experiment name` = "expt",
  `proporition of UMIs as mitochondria` = "proportion_mito",
  `clusters` = "res.0.5",
  `cell_types` = "cell_type",
  `pseudotime` = "Pseudotime",
  `velocity endpoint probability` = "endpoints_imputed",
  `velocity startpoint probability` = "startpoints_imputed")

bcells <- map(bcells, function(sobj){
  sobj@meta.data <- sobj@meta.data[, cols_to_keep]
  colnames(sobj@meta.data) <- names(cols_to_keep)
  sobj@meta.data$cell_types <- str_replace(sobj@meta.data$cell_types, ",", "")
  sobj <- SetAllIdent(sobj, "cell_types")
  sobj
})
```


Split into 2 objects and save rds files


```{r}
outdir <- "cellbrowser"
dir.create(outdir)


# write out rds files with names listed in sobjs
iwalk(bcells, ~saveRDS(.x, 
                   file.path(outdir, 
                                 paste0(.y, ".rds"))))
```




## Set colors
```{r}

## default palette (see ../../R/globals.R)
col_palette <- discrete_palette_default

## make a names list that contains named vectors matching ids to colors


## summarize per cluster annotations
summary_annotations <- map(bcells, 
                           ~group_by(.x@meta.data, 
                                     clusters) %>% 
  dplyr::summarize(cell_types = unique(cell_types),
                   expt = unique(`experiment name`)) %>% 
  as.data.frame())

summary_annotations <- map(summary_annotations, 
                           function(x){
  rownames(x) <- x$clusters
  x <- x[, -1, drop = FALSE]
  x
})

col_maps <- map(summary_annotations, function(x) {
  
  cols <- list()
  cell_types <- x$cell_types %>%
                      unique() %>% 
                      sort()
  
  expts <- x$expt %>%
                      unique() %>% 
                      sort()
  
  clusters <- rownames(x)
  
  cell_type_col_palette <- col_palette[1:length(cell_types)]
  names(cell_type_col_palette) <- cell_types
  
  clusters_col_palette <- col_palette[1:length(clusters)]
  names(clusters_col_palette) <- clusters
  
  expt_col_palette <- col_palette[1:length(expts)]
  names(expt_col_palette) <- expts
  
  cols$cell_type <- cell_type_col_palette
  cols$cluster <- clusters_col_palette
  cols$expt <- expt_col_palette
  cols
})


imap(col_maps, 
    ~map_dfr(.x, ~tibble(clusterName = str_replace(names(.x), ",", ""), 
                  color = .x)) %>% as.data.frame() %>% 
  write_csv(paste0(.y, "_colorMap.csv"), col_names = F, quote_escape = "none"))
```


Build cellbrowser objects. Note requires UCSC (`cellbrowser python package`[ https://cellbrowser.readthedocs.io/index.html])

```{bash}
cd cellbrowser
/miniconda3/bin/cbImportSeurat2 \
  -i Sorted.rds \
  -o Sorted \
  -m \
  -c "cell_types" 
  
/miniconda3/bin/cbImportSeurat2 \
  -i Reaggregated.rds \
  -o Reaggregated \
  -m \
  -c "cell_types" 
  
```


```{bash}
cd cellbrowser

echo -e '\ncolors="/Users/kriemo/Projects/russ/results/2018-12-19_figs/Sorted_colorMap.csv"' >> Sorted/cellbrowser.conf

echo -e '\ncolors="/Users/kriemo/Projects/russ/results/2018-12-19_figs/Reaggregated_colorMap.csv"' >> Reaggregated/cellbrowser.conf
```


```{bash}
cd cellbrowser

/miniconda3/bin/cbBuild \
-i Sorted/cellbrowser.conf \
-i Reaggregated/cellbrowser.conf \
-o beta

```


